<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cognito IAS - Online Exam</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #2c3e50; --success: #27ae60; --danger: #e74c3c; --blue: #3498db; --warning: #f1c40f; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 0; }
        .navbar { background: var(--primary); color: white; padding: 15px; text-align: center; font-weight: bold; font-size: 1.2rem; }
        .container { display: grid; grid-template-columns: 1fr 350px; gap: 20px; padding: 20px; max-width: 1400px; margin: auto; }
        .question-area { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); min-height: 550px; }
        .q-text { font-size: 1.3rem; line-height: 1.6; margin-bottom: 25px; color: #333; }
        .option-card { display: block; padding: 15px; margin: 10px 0; border: 2px solid #eee; border-radius: 8px; cursor: pointer; transition: 0.3s; }
        .option-card:hover { background: #f0f7ff; border-color: var(--blue); }
        input[type="radio"]:checked + span { font-weight: bold; color: var(--blue); }
        .side-panel { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: sticky; top: 20px; height: fit-content; }
        #timer { font-size: 2rem; font-weight: bold; color: var(--danger); text-align: center; border: 3px solid var(--danger); border-radius: 8px; padding: 10px; margin-bottom: 20px; }
        .palette { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 20px; }
        .p-btn { width: 45px; height: 45px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .answered { background: var(--success); color: white; border-color: var(--success); }
        .current { border: 3px solid var(--blue); transform: scale(1.1); }
        .btn { padding: 12px 25px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; }
    </style>
</head>
<body>

<div class="navbar">COGNITO IAS - {{ quiz.topic }}</div>

<div class="container">
    <div class="question-area">
        <div id="q-content">
            </div>

        <div style="margin-top: 40px; display: flex; justify-content: space-between; border-top: 1px solid #eee; padding-top: 20px;">
            <button onclick="prevQ()" class="btn" style="background:#7f8c8d;">Previous</button>
            <button onclick="nextQ()" class="btn" style="background:var(--success);">Save & Next</button>
        </div>
    </div>

    <div class="side-panel">
        <div id="timer">00:00</div>
        <h4>Question Palette</h4>
        <div class="palette" id="palette"></div>
        <button onclick="confirmSubmit()" class="btn" style="background:var(--danger); width: 100%; margin-top: 30px; font-size: 1.2rem;">Final Submit</button>
    </div>
</div>

<script>
    const questions = {{ questions|tojson }};
    const quizId = {{ quiz.id }};
    const negMark = {{ quiz.neg_marking }};
    let currentIdx = 0;
    let userAnswers = new Array(questions.length).fill(null);

    function loadQuestion(idx) {
        currentIdx = idx;
        const q = questions[idx];
        const saved = userAnswers[idx];
        
        let html = `<h3>Question ${idx + 1}</h3><div class="q-text">${q.question}</div>`;
        const labels = ['A', 'B', 'C', 'D'];
        
        q.options.forEach((opt, i) => {
            const letter = labels[i];
            html += `
                <label class="option-card">
                    <input type="radio" name="ans" value="${letter}" ${saved === letter ? 'checked' : ''} onclick="saveAns('${letter}')">
                    <span>${letter}. ${opt}</span>
                </label>`;
        });
        
        document.getElementById('q-content').innerHTML = html;
        renderPalette();
    }

    function saveAns(val) { userAnswers[currentIdx] = val; renderPalette(); }
    function nextQ() { if(currentIdx < questions.length - 1) loadQuestion(currentIdx + 1); }
    function prevQ() { if(currentIdx > 0) loadQuestion(currentIdx - 1); }

    function renderPalette() {
        let html = '';
        userAnswers.forEach((ans, i) => {
            let cls = (i === currentIdx) ? 'current' : (ans ? 'answered' : '');
            html += `<div class="p-btn ${cls}" onclick="loadQuestion(${i})">${i+1}</div>`;
        });
        document.getElementById('palette').innerHTML = html;
    }

    async function confirmSubmit() {
        if(!confirm("Kya aap test submit karna chahte hain?")) return;
        submitTest();
    }

    async function submitTest() {
        let score = 0;
        questions.forEach((q, i) => {
            if(userAnswers[i] === q.correct) score += 1;
            else if(userAnswers[i] !== null) score -= negMark;
        });

        const response = await fetch('/submit_score', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({quiz_id: quizId, score: score.toFixed(2)})
        });

        const data = await response.json();
        if(data.status === 'success') {
            window.location.href = '/rankings/' + quizId;
        } else {
            alert("Score save karne mein galti hui. Login check karein.");
        }
    }

    // Timer Logic
    let timeLeft = {{ quiz.time_limit }} * 60;
    const timerDisplay = document.getElementById('timer');
    setInterval(() => {
        let mins = Math.floor(timeLeft / 60);
        let secs = timeLeft % 60;
        timerDisplay.innerText = `${mins}:${secs < 10 ? '0'+secs : secs}`;
        if(timeLeft <= 0) submitTest();
        timeLeft--;
    }, 1000);

    loadQuestion(0);
</script>
</body>
</html>
